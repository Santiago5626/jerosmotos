name: Keep Render Services Alive

on:
  schedule:
    # Se ejecuta cada 14 minutos entre las 6 AM y 11:59 PM (hora de Colombia UTC-5)
    # Colombia UTC-5 convertido a UTC:
    # 6 AM Colombia = 11 AM UTC
    # 12 AM Colombia (medianoche) = 5 AM UTC del d√≠a siguiente
    - cron: '*/14 11-23 * * *'  # De 6 AM a 6:59 PM (Colombia)
    - cron: '*/14 0-4 * * *'     # De 7 PM a 11:59 PM (Colombia)
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
  ping-services:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar horario permitido
        id: check-time
        run: |
          # Obtener hora actual en Colombia (UTC-5)
          CURRENT_HOUR=$(TZ=America/Bogota date +%H)
          CURRENT_TIME=$(TZ=America/Bogota date +"%Y-%m-%d %H:%M:%S")
          echo "Hora actual en Colombia: $CURRENT_TIME"
          
          # Verificar si estamos en horario permitido (6 AM - 12 AM)
          if [ $CURRENT_HOUR -ge 6 ] || [ $CURRENT_HOUR -lt 0 ]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Horario permitido. Procediendo con ping..."
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Fuera del horario permitido (12 AM - 6 AM). Servicios pueden dormir."
          fi

      - name: Ping Backend API
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "üîÑ Haciendo ping al backend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://jerosmotos-api.onrender.com/ping)
          echo "Respuesta del backend: $response"
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Backend respondi√≥ correctamente"
          else
            echo "‚ö†Ô∏è Backend respondi√≥ con c√≥digo: $response"
            exit 1
          fi

      - name: Ping Frontend
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "üîÑ Haciendo ping al frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://jerosmotos.onrender.com/)
          echo "Respuesta del frontend: $response"
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Frontend respondi√≥ correctamente"
          else
            echo "‚ö†Ô∏è Frontend respondi√≥ con c√≥digo: $response"
            exit 1
          fi

      - name: Resumen
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "‚úÖ Keep-alive completado exitosamente"
          echo "Pr√≥ximo ping en ~14 minutos"
